以下为代办事项，行首有 * 的表示是一个开发任务，其余为提示内容，往往每个开发任务下方会有一些提示内容，"@提示内容"下方到"@解决方案"前是提示内容，”@解决方案“到下一个开发任务前是解决方案，需要你完成任务后填写你的实际解决方案。请你按照顺序完成任务，对于你觉得已经完成的任务，请在其后面打钩 √ ，我会检查是否真的完成，如果我觉得未完成，我会删除 √ 表示需要你重做，或者 改为 × 表示需要完善。

完成附件功能
* 第一步 完成发送附件功能（主要修改前端） √
@提示内容
以下是询问gpt后，得知的发送附件实现方案，需要前端对附件进行处理

---

## 一、邮箱发送附件的整体思路

电子邮件发送附件并不是直接“贴上一个文件就发出去”，而是通过 **MIME（Multipurpose Internet Mail Extensions，多用途互联网邮件扩展）** 把附件编码成文本，再通过 **SMTP** 协议传输。

---

## 二、详细流程

### 1. 用户操作层面

1. **选择附件**
   用户在邮件客户端（Outlook、Foxmail、Gmail 网页等）选择一个或多个本地文件。
2. **邮件客户端封装**
   客户端会读取这些文件，并使用 **Base64** 等方式编码成纯文本（因为邮件协议是文本协议）。

---

### 2. MIME 封装

1. **生成 MIME 边界标识（boundary）**
   用来区分不同的邮件部分（正文、附件等）。
2. **正文部分**
   普通文本或 HTML 格式放在第一个 MIME part。
3. **附件部分**
   每个附件单独一个 MIME part，包含：

    * `Content-Type`（文件类型，如 image/png）
    * `Content-Disposition`（声明是附件及文件名）
    * `Content-Transfer-Encoding`（如 Base64）
4. **合并**
   所有部分用 boundary 串接，形成完整的 MIME 邮件。

---

### 3. SMTP 发送

1. **建立 SMTP 连接**
   客户端 → SMTP 服务器（加密可用 STARTTLS/SMTPS）。
2. **SMTP 命令发送邮件头**

    * `MAIL FROM`：发件人
    * `RCPT TO`：收件人
    * `DATA`：开始发送正文
3. **传输 MIME 邮件内容**
   将 MIME 格式的邮件（正文 + 附件编码）发送给 SMTP 服务器。
4. **结束传输**
   用 `.` 单独一行结束邮件数据。

---

### 4. 服务器处理

1. **SMTP 服务器接收邮件**
   存储到邮件队列。
2. **路由转发**
   根据收件人域名，通过 DNS MX 记录找到目标邮件服务器。
3. **目标邮件服务器存储**
   存储到收件人的邮箱（IMAP/POP3 服务器）。

---

### 5. 收件端解析

1. **邮件客户端获取邮件**
   通过 IMAP 或 POP3 拉取邮件内容。
2. **解析 MIME**
   按 boundary 分割各部分。
3. **解码附件**
   将 Base64 文本转回二进制文件，还原为原始文件。

---

## 三、流程图

```
[用户选择附件] 
       ↓
[邮件客户端读取文件并Base64编码]
       ↓
[封装为MIME邮件：正文 + 附件部分]
       ↓
[SMTP 建立连接 → 发送邮件数据]
       ↓
[SMTP服务器接收 → 存储邮件队列]
       ↓
[根据MX记录转发到收件人服务器]
       ↓
[收件人服务器存储到邮箱]
       ↓
[收件人客户端通过IMAP/POP3拉取邮件]
       ↓
[解析MIME → 解码Base64 → 还原附件]
```
@解决方案

我已经完成了邮件附件发送功能的实现，具体包括以下几个方面：

### 1. 前端实现（web/src/views/email/Compose.vue）

**附件选择和管理功能：**
- 实现了文件拖拽上传和点击选择文件功能
- 添加了文件类型验证（支持jpg, jpeg, png, gif, pdf, doc, docx, xls, xlsx, txt, zip）
- 添加了文件大小限制（最大10MB）
- 实现了附件列表显示，包括文件名、大小和删除功能
- 添加了重复文件检查

**文件处理功能：**
- 实现了文件转Base64编码的功能
- 在发送邮件时将附件数据包含在请求中
- 添加了附件处理的错误处理机制

### 2. 后端类型定义更新（internal/types/email.go）

**更新了邮件发送请求结构：**
- 将`Attachments`字段从`string`类型改为`[]AttachmentData`类型
- 新增了`AttachmentData`结构体，包含文件名、MIME类型、Base64数据和文件大小

### 3. 后端邮件发送逻辑更新（internal/handler/email.go）

**附件处理逻辑：**
- 添加了Base64解码功能，将前端传来的Base64数据转换为字节数组
- 构建`service.EmailAttachment`结构体传递给SMTP服务
- 添加了附件数据格式验证和错误处理

**数据库存储：**
- 在邮件发送成功后，为每个附件创建数据库记录
- 使用现有的`EmailAttachmentModel`保存附件元数据

### 4. 前端类型定义更新（web/src/types/index.ts）

**更新了邮件发送请求接口：**
- 将`attachments`字段类型从`string`改为`AttachmentData[]`
- 新增了`AttachmentData`接口定义

### 5. 技术实现要点

**MIME邮件封装：**
- 后端的SMTP服务（internal/service/smtp.go）已经实现了完整的MIME邮件封装
- 使用go-mail库自动处理MIME边界、Content-Type、Content-Disposition等头部
- 支持Base64编码的附件传输

**文件处理流程：**
1. 用户在前端选择文件（拖拽或点击）
2. 前端验证文件类型和大小
3. 前端将文件转换为Base64编码
4. 发送邮件时将附件数据包含在请求中
5. 后端解码Base64数据并构建SMTP附件
6. 通过SMTP协议发送包含附件的MIME邮件
7. 保存附件元数据到数据库

这个实现完全遵循了MIME邮件标准，附件通过Base64编码直接嵌入到邮件中，无需额外的文件存储服务。
















