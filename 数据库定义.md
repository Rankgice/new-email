# 邮件管理系统 - 数据库定义文档

## 一、数据库设计概述

本文档基于需求文档和技术方案，采用GORM结构体定义数据表结构。数据库支持SQLite（开发环境）和MySQL（生产环境）。

---

## 二、核心数据表结构

### 1. 用户管理相关

#### 1.1 用户表 (users)
```go
type User struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Username    string    `gorm:"uniqueIndex;size:50;not null" json:"username"`
    Email       string    `gorm:"uniqueIndex;size:100;not null" json:"email"`
    Password    string    `gorm:"size:255;not null" json:"-"`
    Nickname    string    `gorm:"size:50" json:"nickname"`
    Avatar      string    `gorm:"size:255" json:"avatar"`
    Role        string    `gorm:"size:20;default:user" json:"role"` // admin, user
    Status      int       `gorm:"default:1" json:"status"`          // 1:启用 0:禁用
    LastLoginAt *time.Time `json:"last_login_at"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`
}
```

#### 1.2 用户第三方登录表 (user_oauth)
```go
type UserOAuth struct {
    ID         uint   `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID     uint   `gorm:"not null;index" json:"user_id"`
    Provider   string `gorm:"size:20;not null" json:"provider"` // qq, microsoft, google
    ProviderID string `gorm:"size:100;not null" json:"provider_id"`
    CreatedAt  time.Time `json:"created_at"`
    UpdatedAt  time.Time `json:"updated_at"`
    
    User User `gorm:"foreignKey:UserID" json:"user"`
}
```

### 2. 域名管理相关

#### 2.1 域名表 (domains)
```go
type Domain struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name        string    `gorm:"uniqueIndex;size:100;not null" json:"name"`
    Status      int       `gorm:"default:1" json:"status"`        // 1:启用 0:禁用
    DnsVerified bool      `gorm:"default:false" json:"dns_verified"`
    DkimRecord  string    `gorm:"type:text" json:"dkim_record"`
    SpfRecord   string    `gorm:"type:text" json:"spf_record"`
    DmarcRecord string    `gorm:"type:text" json:"dmarc_record"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`
}
```

### 3. 邮箱管理相关

#### 3.1 邮箱账户表 (mailboxes)
```go
type Mailbox struct {
    ID           uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID       uint      `gorm:"not null;index" json:"user_id"`
    DomainID     *uint     `gorm:"index" json:"domain_id"`        // 自建邮箱关联域名
    Email        string    `gorm:"uniqueIndex;size:100;not null" json:"email"`
    Password     string    `gorm:"size:255;not null" json:"-"`
    Type         string    `gorm:"size:20;not null" json:"type"`  // self:自建 third:第三方
    Provider     string    `gorm:"size:50" json:"provider"`       // gmail, outlook, qq, imap
    ImapHost     string    `gorm:"size:100" json:"imap_host"`
    ImapPort     int       `gorm:"default:993" json:"imap_port"`
    SmtpHost     string    `gorm:"size:100" json:"smtp_host"`
    SmtpPort     int       `gorm:"default:587" json:"smtp_port"`
    ClientID     string    `gorm:"size:255" json:"client_id"`     // OAuth客户端ID
    RefreshToken string    `gorm:"size:500" json:"refresh_token"` // OAuth刷新令牌
    Status       int       `gorm:"default:1" json:"status"`       // 1:启用 0:禁用
    AutoReceive  bool      `gorm:"default:true" json:"auto_receive"`
    LastSyncAt   *time.Time `json:"last_sync_at"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
    DeletedAt    gorm.DeletedAt `gorm:"index" json:"-"`
    
    User   User    `gorm:"foreignKey:UserID" json:"user"`
    Domain *Domain `gorm:"foreignKey:DomainID" json:"domain"`
}
```

### 4. 邮件相关

#### 4.1 邮件表 (emails)
```go
type Email struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    MailboxID   uint      `gorm:"not null;index" json:"mailbox_id"`
    MessageID   string    `gorm:"size:255;index" json:"message_id"`
    Subject     string    `gorm:"size:500" json:"subject"`
    FromEmail   string    `gorm:"size:100;index" json:"from_email"`
    FromName    string    `gorm:"size:100" json:"from_name"`
    ToEmails    string    `gorm:"type:text" json:"to_emails"`    // JSON数组格式
    CcEmails    string    `gorm:"type:text" json:"cc_emails"`    // JSON数组格式
    BccEmails   string    `gorm:"type:text" json:"bcc_emails"`   // JSON数组格式
    ReplyTo     string    `gorm:"size:100" json:"reply_to"`
    ContentType string    `gorm:"size:20;default:html" json:"content_type"` // html, text
    Content     string    `gorm:"type:longtext" json:"content"`
    IsRead      bool      `gorm:"default:false" json:"is_read"`
    IsStarred   bool      `gorm:"default:false" json:"is_starred"`
    Direction   string    `gorm:"size:10;not null" json:"direction"` // sent, received
    SentAt      *time.Time `json:"sent_at"`
    ReceivedAt  *time.Time `json:"received_at"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`
    
    Mailbox     Mailbox           `gorm:"foreignKey:MailboxID" json:"mailbox"`
    Attachments []EmailAttachment `gorm:"foreignKey:EmailID" json:"attachments"`
}
```

#### 4.2 邮件附件表 (email_attachments)
```go
type EmailAttachment struct {
    ID        uint   `gorm:"primaryKey;autoIncrement" json:"id"`
    EmailID   uint   `gorm:"not null;index" json:"email_id"`
    Filename  string `gorm:"size:255;not null" json:"filename"`
    FilePath  string `gorm:"size:500;not null" json:"file_path"`
    FileSize  int64  `gorm:"not null" json:"file_size"`
    MimeType  string `gorm:"size:100" json:"mime_type"`
    CreatedAt time.Time `json:"created_at"`
    
    Email Email `gorm:"foreignKey:EmailID" json:"email"`
}
```

### 5. 邮件模板和签名

#### 5.1 邮件模板表 (email_templates)
```go
type EmailTemplate struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID      uint      `gorm:"not null;index" json:"user_id"`
    Name        string    `gorm:"size:100;not null" json:"name"`
    Subject     string    `gorm:"size:500" json:"subject"`
    Content     string    `gorm:"type:longtext" json:"content"`
    ContentType string    `gorm:"size:20;default:html" json:"content_type"`
    IsDefault   bool      `gorm:"default:false" json:"is_default"`
    Status      int       `gorm:"default:1" json:"status"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`
    
    User User `gorm:"foreignKey:UserID" json:"user"`
}
```

#### 5.2 邮件签名表 (email_signatures)
```go
type EmailSignature struct {
    ID        uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID    uint      `gorm:"not null;index" json:"user_id"`
    Name      string    `gorm:"size:100;not null" json:"name"`
    Content   string    `gorm:"type:text" json:"content"`
    IsDefault bool      `gorm:"default:false" json:"is_default"`
    Status    int       `gorm:"default:1" json:"status"`
    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`
    
    User User `gorm:"foreignKey:UserID" json:"user"`
}
```

### 6. 规则管理相关

#### 6.1 验证码规则表 (verification_rules)
```go
type VerificationRule struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name        string    `gorm:"size:100;not null" json:"name"`
    Pattern     string    `gorm:"type:text;not null" json:"pattern"`     // 正则表达式
    Description string    `gorm:"type:text" json:"description"`
    IsGlobal    bool      `gorm:"default:false" json:"is_global"`        // 是否全局规则
    Status      int       `gorm:"default:1" json:"status"`               // 1:启用 0:禁用
    Priority    int       `gorm:"default:0" json:"priority"`             // 优先级，数字越大优先级越高
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`
}
```

#### 6.2 用户验证码规则关联表 (user_verification_rules)
```go
type UserVerificationRule struct {
    ID     uint `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID uint `gorm:"not null;index" json:"user_id"`
    RuleID uint `gorm:"not null;index" json:"rule_id"`
    Status int  `gorm:"default:1" json:"status"`
    CreatedAt time.Time `json:"created_at"`

    User User             `gorm:"foreignKey:UserID" json:"user"`
    Rule VerificationRule `gorm:"foreignKey:RuleID" json:"rule"`
}
```

#### 6.3 转发规则表 (forward_rules)
```go
type ForwardRule struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID        uint      `gorm:"not null;index" json:"user_id"`
    Name          string    `gorm:"size:100;not null" json:"name"`
    FromPattern   string    `gorm:"size:255" json:"from_pattern"`          // 发件人匹配规则
    SubjectPattern string   `gorm:"size:255" json:"subject_pattern"`       // 主题匹配规则
    ContentPattern string   `gorm:"type:text" json:"content_pattern"`      // 内容匹配规则
    ForwardTo     string    `gorm:"size:255;not null" json:"forward_to"`   // 转发目标邮箱
    KeepOriginal  bool      `gorm:"default:true" json:"keep_original"`     // 是否保留原邮件
    Status        int       `gorm:"default:1" json:"status"`
    Priority      int       `gorm:"default:0" json:"priority"`
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`

    User User `gorm:"foreignKey:UserID" json:"user"`
}
```

#### 6.4 反垃圾规则表 (anti_spam_rules)
```go
type AntiSpamRule struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name          string    `gorm:"size:100;not null" json:"name"`
    RuleType      string    `gorm:"size:20;not null" json:"rule_type"`     // blacklist, whitelist, keyword, regex
    Pattern       string    `gorm:"type:text;not null" json:"pattern"`
    Action        string    `gorm:"size:20;not null" json:"action"`        // block, quarantine, mark
    Description   string    `gorm:"type:text" json:"description"`
    IsGlobal      bool      `gorm:"default:false" json:"is_global"`
    Status        int       `gorm:"default:1" json:"status"`
    Priority      int       `gorm:"default:0" json:"priority"`
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
}
```

### 7. 系统配置相关

#### 7.1 系统设置表 (system_settings)
```go
type SystemSetting struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Key         string    `gorm:"uniqueIndex;size:100;not null" json:"key"`
    Value       string    `gorm:"type:text" json:"value"`
    Type        string    `gorm:"size:20;default:string" json:"type"`    // string, int, bool, json
    Description string    `gorm:"type:text" json:"description"`
    IsPublic    bool      `gorm:"default:false" json:"is_public"`        // 是否允许前端访问
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

### 8. 日志相关

#### 8.1 操作日志表 (operation_logs)
```go
type OperationLog struct {
    ID         uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID     *uint     `gorm:"index" json:"user_id"`
    Action     string    `gorm:"size:100;not null" json:"action"`
    Resource   string    `gorm:"size:100" json:"resource"`
    ResourceID *uint     `json:"resource_id"`
    Method     string    `gorm:"size:10" json:"method"`
    Path       string    `gorm:"size:255" json:"path"`
    IP         string    `gorm:"size:45" json:"ip"`
    UserAgent  string    `gorm:"size:500" json:"user_agent"`
    Request    string    `gorm:"type:text" json:"request"`
    Response   string    `gorm:"type:text" json:"response"`
    Status     int       `json:"status"`
    Duration   int64     `json:"duration"` // 毫秒
    CreatedAt  time.Time `json:"created_at"`

    User *User `gorm:"foreignKey:UserID" json:"user"`
}
```

#### 8.2 邮件日志表 (email_logs)
```go
type EmailLog struct {
    ID         uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    MailboxID  uint      `gorm:"not null;index" json:"mailbox_id"`
    EmailID    *uint     `gorm:"index" json:"email_id"`
    Type       string    `gorm:"size:20;not null" json:"type"`          // send, receive, sync
    Status     string    `gorm:"size:20;not null" json:"status"`        // success, failed, pending
    Message    string    `gorm:"type:text" json:"message"`
    ErrorCode  string    `gorm:"size:50" json:"error_code"`
    ErrorMsg   string    `gorm:"type:text" json:"error_msg"`
    StartedAt  time.Time `json:"started_at"`
    FinishedAt *time.Time `json:"finished_at"`
    CreatedAt  time.Time `json:"created_at"`

    Mailbox Mailbox `gorm:"foreignKey:MailboxID" json:"mailbox"`
    Email   *Email  `gorm:"foreignKey:EmailID" json:"email"`
}
```

### 9. API访问相关

#### 9.1 API密钥表 (api_keys)
```go
type ApiKey struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID      uint      `gorm:"not null;index" json:"user_id"`
    Name        string    `gorm:"size:100;not null" json:"name"`
    Key         string    `gorm:"uniqueIndex;size:64;not null" json:"key"`
    Secret      string    `gorm:"size:128;not null" json:"-"`
    Permissions string    `gorm:"type:text" json:"permissions"`          // JSON数组格式
    Status      int       `gorm:"default:1" json:"status"`
    LastUsedAt  *time.Time `json:"last_used_at"`
    ExpiresAt   *time.Time `json:"expires_at"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`

    User User `gorm:"foreignKey:UserID" json:"user"`
}
```

### 10. 验证码提取记录

#### 10.1 验证码记录表 (verification_codes)
```go
type VerificationCode struct {
    ID        uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    EmailID   uint      `gorm:"not null;index" json:"email_id"`
    RuleID    uint      `gorm:"not null;index" json:"rule_id"`
    Code      string    `gorm:"size:50;not null" json:"code"`
    Source    string    `gorm:"size:100" json:"source"`                // 提取来源（发件人）
    ExtractedAt time.Time `json:"extracted_at"`
    IsUsed    bool      `gorm:"default:false" json:"is_used"`
    UsedAt    *time.Time `json:"used_at"`
    CreatedAt time.Time `json:"created_at"`

    Email Email            `gorm:"foreignKey:EmailID" json:"email"`
    Rule  VerificationRule `gorm:"foreignKey:RuleID" json:"rule"`
}
```

### 11. 草稿邮件

#### 11.1 草稿邮件表 (email_drafts)
```go
type EmailDraft struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID      uint      `gorm:"not null;index" json:"user_id"`
    MailboxID   uint      `gorm:"not null;index" json:"mailbox_id"`
    Subject     string    `gorm:"size:500" json:"subject"`
    ToEmails    string    `gorm:"type:text" json:"to_emails"`    // JSON数组格式
    CcEmails    string    `gorm:"type:text" json:"cc_emails"`    // JSON数组格式
    BccEmails   string    `gorm:"type:text" json:"bcc_emails"`   // JSON数组格式
    ContentType string    `gorm:"size:20;default:html" json:"content_type"`
    Content     string    `gorm:"type:longtext" json:"content"`
    ScheduledAt *time.Time `json:"scheduled_at"`                 // 定时发送时间
    Status      string    `gorm:"size:20;default:draft" json:"status"` // draft, scheduled, sent
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`

    User    User    `gorm:"foreignKey:UserID" json:"user"`
    Mailbox Mailbox `gorm:"foreignKey:MailboxID" json:"mailbox"`
}
```

---

## 三、数据库索引设计

### 主要索引
- `users`: username, email, status, role
- `mailboxes`: user_id, email, status, type, provider
- `emails`: mailbox_id, from_email, direction, sent_at, received_at, is_read
- `email_logs`: mailbox_id, type, status, started_at
- `verification_codes`: email_id, rule_id, extracted_at, is_used
- `operation_logs`: user_id, action, created_at
- `api_keys`: user_id, key, status
- `email_drafts`: user_id, mailbox_id, status

### 复合索引
- `emails`: (mailbox_id, direction, sent_at)
- `email_logs`: (mailbox_id, type, status)
- `verification_codes`: (email_id, rule_id)
- `user_verification_rules`: (user_id, rule_id)

---

## 四、数据库初始化

### 默认数据
1. **系统设置默认值**
   - site_title: "邮件管理系统"
   - site_logo: ""
   - smtp_default_host: ""
   - smtp_default_port: "587"
   - registration_enabled: "true"
   - max_attachment_size: "10485760" (10MB)

2. **默认管理员账户**
   - username: "admin"
   - email: "admin@example.com"
   - password: "admin123" (需要加密)
   - role: "admin"

3. **默认验证码规则**
   - 通用数字验证码: `\b\d{4,8}\b`
   - 通用字母数字验证码: `\b[A-Za-z0-9]{4,8}\b`
   - 邮箱验证码: `验证码[：:]\s*([A-Za-z0-9]{4,8})`

---

## 五、数据库迁移说明

使用GORM的AutoMigrate功能进行数据库迁移：

```go
func AutoMigrate(db *gorm.DB) error {
    return db.AutoMigrate(
        &User{},
        &UserOAuth{},
        &Domain{},
        &Mailbox{},
        &Email{},
        &EmailAttachment{},
        &EmailTemplate{},
        &EmailSignature{},
        &VerificationRule{},
        &UserVerificationRule{},
        &ForwardRule{},
        &AntiSpamRule{},
        &SystemSetting{},
        &OperationLog{},
        &EmailLog{},
        &ApiKey{},
        &VerificationCode{},
        &EmailDraft{},
    )
}
```

---

## 六、注意事项

### 1. 数据安全
- 密码字段使用`json:"-"`标签避免序列化输出
- API密钥的secret字段需要加密存储
- 敏感操作需要记录操作日志
- 邮箱密码和OAuth令牌需要加密存储

### 2. 性能优化
- 邮件内容使用`longtext`类型支持大容量
- 合理使用索引提升查询性能
- 考虑对历史邮件进行分表或归档
- 大量邮件查询时使用分页和缓存

### 3. 扩展性
- 预留足够的字段长度
- 使用JSON格式存储复杂数据结构（如收件人列表、权限配置）
- 支持软删除便于数据恢复
- 规则系统支持优先级和灵活配置

### 4. 兼容性
- 结构体设计兼容SQLite和MySQL
- 时间字段统一使用time.Time类型
- 字符集使用UTF-8支持多语言
- 支持第三方邮箱的OAuth认证

### 5. 业务逻辑
- 验证码提取支持多种规则匹配
- 转发规则支持复杂的匹配条件
- 反垃圾规则支持多种过滤策略
- 邮件模板和签名支持富文本格式

---

## 七、数据表关系图

```
Users (用户表)
├── UserOAuth (第三方登录)
├── Mailboxes (邮箱账户)
│   ├── Emails (邮件)
│   │   ├── EmailAttachments (附件)
│   │   └── VerificationCodes (验证码)
│   ├── EmailLogs (邮件日志)
│   └── EmailDrafts (草稿)
├── EmailTemplates (邮件模板)
├── EmailSignatures (邮件签名)
├── UserVerificationRules (用户验证码规则)
├── ForwardRules (转发规则)
└── ApiKeys (API密钥)

Domains (域名表)
└── Mailboxes (邮箱账户)

VerificationRules (验证码规则)
├── UserVerificationRules (用户规则关联)
└── VerificationCodes (验证码记录)

AntiSpamRules (反垃圾规则) - 独立表
SystemSettings (系统设置) - 独立表
OperationLogs (操作日志) - 独立表
```

---

## 八、总结

本数据库设计涵盖了邮件管理系统的所有核心功能：

1. **用户管理** - 支持多角色用户和第三方登录
2. **邮箱管理** - 支持自建邮箱和第三方邮箱集成
3. **邮件处理** - 完整的邮件收发、存储、查询功能
4. **规则引擎** - 灵活的验证码提取、转发和反垃圾规则
5. **模板系统** - 邮件模板和签名管理
6. **日志审计** - 完整的操作和邮件日志记录
7. **API支持** - 支持API密钥访问和权限控制
8. **草稿功能** - 支持邮件草稿保存和定时发送

该设计遵循GORM最佳实践，支持数据库迁移，具备良好的扩展性和维护性。
```
